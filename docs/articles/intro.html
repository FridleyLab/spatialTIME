<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Introduction to spatialTIME • spatialTIME</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Introduction to spatialTIME">
<meta property="og:description" content="spatialTIME">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">spatialTIME</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.3.4-1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/intro.html">Introduction to spatialTIME</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/FridleyLab/spatialTIME/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Introduction to spatialTIME</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/FridleyLab/spatialTIME/blob/HEAD/vignettes/intro.Rmd" class="external-link"><code>vignettes/intro.Rmd</code></a></small>
      <div class="hidden name"><code>intro.Rmd</code></div>

    </div>

    
    
<style type="text/css">
    body .main-container {
      max-width: 1500px !important;
      width: 1500px !important;
    }
    body {
      max-width: 1500px !important;
    }
</style>
<div class="section level2">
<h2 id="background-for-tissue-microarray-tma-data">Background for Tissue Microarray (TMA) Data<a class="anchor" aria-label="anchor" href="#background-for-tissue-microarray-tma-data"></a>
</h2>
<p>A tissue microarray (TMA) is an array of samples which are obtained
by taking a slice of a biopsied FFPE tumor. Each individual slice is
referred to as a core. Each core is placed on a TMA and is then stained
with multiple antibodies and fluorophores which illuminate when a laser
is shined at them with varying wavelengths. The intensity is measured
and then a random forest algorithm is used to classify the cells as
being positive for a particular marker which allows us to phenotype
cells. A schematic of this process is provided in <a href="https://www.mdpi.com/2072-6694/13/12/3031" class="external-link">Figure 1</a>.</p>
</div>
<div class="section level2">
<h2 id="create-multiplex-immunoflourescent-mif-object">Create Multiplex ImmunoFlourescent (mif) Object<a class="anchor" aria-label="anchor" href="#create-multiplex-immunoflourescent-mif-object"></a>
</h2>
<p>spatialTIME functions use a custom <code>mif</code> object which can
be created using <code>create_mif</code>. The <code>mif</code> object
has 6 slots storing the:</p>
<ul>
<li>Clinical data which must contain:
<ul>
<li>a column whose column name matches one in the sample dataset.</li>
</ul>
</li>
<li>Sample summary data including counts/percentages of each positive
cells for each single or combination of markers and total number of
cells for each core. In order to use <code>create_mif</code> function
this table must contain:
<ul>
<li>a column whose column name matches one in the clinical dataset,
and</li>
<li>a column whose column name matches one in the spatial list.</li>
</ul>
</li>
<li>Spatial list (1 per each core):
<ul>
<li>This object should be a list object where each element of the list
corresponds to a core and each element should be a <span class="math inline">\(n\times p\)</span> dataframe (<span class="math inline">\(n\)</span> = number of cells) containing:
<ol style="list-style-type: decimal">
<li>a column name that matches a column name for the sample file (for
merging and potential downstream analysis linking to clinical
variables),</li>
<li>
<code>XMin</code>, <code>XMax</code>, <code>YMin</code>, and
<code>YMax</code> which defines the area that a cell occupies which is
eventually used to assign a location for each cell with the x-position
being the mean of the <code>XMin</code> and <code>XMax</code> and
y-position being the mean of the <code>YMin</code> and
<code>YMax</code>, and</li>
<li>a set of columns that indicate whether a cell is positive to one or
multiple markers.</li>
</ol>
</li>
</ul>
</li>
<li>patient id:
<ul>
<li>a column name used to merge clinical and summary data</li>
</ul>
</li>
<li>sample_id:
<ul>
<li>a column name used to merge the spatial and summary data</li>
</ul>
</li>
<li>derived:
<ul>
<li>where all of the plots and spatial clustering measures are
stored</li>
</ul>
</li>
</ul>
<p>We include one example of a clinical and sample dataset which have a
total of 229 patients with one core. Out of those 229 samples, only 5
are included in our package.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Make sure the variable types are the same for deidentified_id and </span></span>
<span><span class="co"># deidentified_sample in their corresponding datasets</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_mif.html">create_mif</a></span><span class="op">(</span>clinical_data <span class="op">=</span> <span class="va">example_clinical</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>                  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>deidentified_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">deidentified_id</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                sample_data <span class="op">=</span> <span class="va">example_summary</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>                  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>deidentified_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">deidentified_id</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                spatial_list <span class="op">=</span> <span class="va">example_spatial</span>,</span>
<span>                patient_id <span class="op">=</span> <span class="st">"deidentified_id"</span>, </span>
<span>                sample_id <span class="op">=</span> <span class="st">"deidentified_sample"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">x</span> <span class="co">#prints a summary of how many patients, samples, and spatial files are present</span></span>
<span><span class="co">#&gt; <span style="color: #00D7FF;">229</span> patients spanning <span style="color: #00D7FF;">229</span> samples and <span style="color: #00D7FF;">5</span> spatial data frames were found</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="plotting-cores">Plotting Cores<a class="anchor" aria-label="anchor" href="#plotting-cores"></a>
</h2>
<p>An individual plot for each core (each sample) is created. Plots can
be assigned to an R object, such as within the empty
<code>derived</code> slot and printed to a PDF if a file name is
provided.</p>
<p>When studying phenotype and individual markers, note that it is
important to have the individual before the phenotype markers. This will
ensure that the phenotype that are derived by multiple markers are not
plotted over by the individual marker. For instance, below the the first
plot appears to have no cytotoxic T cells (CD3+ and CD8+), but then the
order is changed we see the cytotoxic T cells. Moral of the story: Put
the marker combinations before the single markers.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mnames_bad</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"CD3..CD8."</span>,<span class="st">"CD3..FOXP3."</span>,<span class="st">"CD3..Opal.570..Positive"</span>,</span>
<span>                <span class="st">"CD8..Opal.520..Positive"</span>,<span class="st">"FOXP3..Opal.620..Positive"</span>, </span>
<span>                <span class="st">"PDL1..Opal.540..Positive"</span>, <span class="st">"PD1..Opal.650..Positive"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Used to make the legends in both plots below be in same order and use the </span></span>
<span><span class="co"># same coloring scheme for the purpose making a common legend</span></span>
<span></span>
<span><span class="va">values</span> <span class="op">=</span>  <span class="fu">RColorBrewer</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/RColorBrewer/man/ColorBrewer.html" class="external-link">brewer.pal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">mnames_bad</span><span class="op">)</span>, <span class="st">"Accent"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">values</span><span class="op">)</span> <span class="op">=</span> <span class="va">mnames_bad</span></span>
<span></span>
<span><span class="co">#add an element in the `derived` object position</span></span>
<span><span class="va">x</span><span class="op">&lt;-</span> <span class="fu"><a href="../reference/plot_immunoflo.html">plot_immunoflo</a></span><span class="op">(</span><span class="va">x</span>, plot_title <span class="op">=</span> <span class="st">"deidentified_sample"</span>,  mnames <span class="op">=</span> <span class="va">mnames_bad</span>,</span>
<span>                   cell_type <span class="op">=</span> <span class="st">"Classifier.Label"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: `progress_estimated()` was deprecated in dplyr 1.0.0.</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> The deprecated feature was likely used in the <span style="color: #0000BB;">spatialTIME</span> package.</span></span>
<span><span class="co">#&gt;   Please report the issue at</span></span>
<span><span class="co">#&gt;   <span style="color: #0000BB; font-style: italic;">&lt;https://github.com/FridleyLab/spatialTIME/issues&gt;</span>.</span></span>
<span><span class="co">#&gt; <span style="color: #555555;">This warning is displayed once every 8 hours.</span></span></span>
<span><span class="co">#&gt; <span style="color: #555555;">Call `lifecycle::last_lifecycle_warnings()` to see where this warning was</span></span></span>
<span><span class="co">#&gt; <span style="color: #555555;">generated.</span></span></span>
<span><span class="co">#&gt; Scale for <span style="color: #00BB00;">y</span> is already present.</span></span>
<span><span class="co">#&gt; Adding another scale for <span style="color: #00BB00;">y</span>, which will replace the existing scale.</span></span>
<span><span class="co">#&gt; Scale for <span style="color: #00BB00;">y</span> is already present.</span></span>
<span><span class="co">#&gt; Adding another scale for <span style="color: #00BB00;">y</span>, which will replace the existing scale.</span></span>
<span><span class="co">#&gt; Scale for <span style="color: #00BB00;">y</span> is already present.</span></span>
<span><span class="co">#&gt; Adding another scale for <span style="color: #00BB00;">y</span>, which will replace the existing scale.</span></span>
<span><span class="co">#&gt; Scale for <span style="color: #00BB00;">y</span> is already present.</span></span>
<span><span class="co">#&gt; Adding another scale for <span style="color: #00BB00;">y</span>, which will replace the existing scale.</span></span>
<span><span class="co">#&gt; Scale for <span style="color: #00BB00;">y</span> is already present.</span></span>
<span><span class="co">#&gt; Adding another scale for <span style="color: #00BB00;">y</span>, which will replace the existing scale.</span></span>
<span></span>
<span><span class="va">bad_names</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">[[</span><span class="st">"derived"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"spatial_plots"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="fl">4</span><span class="op">]</span><span class="op">]</span> <span class="op">+</span> </span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">'bottom'</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">scale_color_manual</span><span class="op">(</span>breaks <span class="op">=</span> <span class="va">mnames_bad</span>,</span>
<span>                     values <span class="op">=</span> <span class="va">values</span>,</span>
<span>                     labels <span class="op">=</span> <span class="va">mnames_bad</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>                       <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"..Opal.*"</span>, <span class="st">"+"</span>, <span class="va">.</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>                       <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"\\.\\."</span>, <span class="st">"+"</span>, <span class="va">.</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>                       <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"\\."</span>, <span class="st">"+"</span>, <span class="va">.</span><span class="op">)</span><span class="op">)</span> </span>
<span><span class="co">#&gt; Scale for <span style="color: #00BB00;">colour</span> is already present.</span></span>
<span><span class="co">#&gt; Adding another scale for <span style="color: #00BB00;">colour</span>, which will replace the existing scale.</span></span>
<span></span>
<span><span class="va">mnames_good</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"CD3..Opal.570..Positive"</span>,<span class="st">"CD8..Opal.520..Positive"</span>,</span>
<span>                 <span class="st">"FOXP3..Opal.620..Positive"</span>,<span class="st">"PDL1..Opal.540..Positive"</span>,</span>
<span>                 <span class="st">"PD1..Opal.650..Positive"</span>,<span class="st">"CD3..CD8."</span>,<span class="st">"CD3..FOXP3."</span><span class="op">)</span></span>
<span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/plot_immunoflo.html">plot_immunoflo</a></span><span class="op">(</span><span class="va">x</span>, plot_title <span class="op">=</span> <span class="st">"deidentified_sample"</span>, mnames <span class="op">=</span> <span class="va">mnames_good</span>, </span>
<span>                    cell_type <span class="op">=</span> <span class="st">"Classifier.Label"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Scale for <span style="color: #00BB00;">y</span> is already present.</span></span>
<span><span class="co">#&gt; Adding another scale for <span style="color: #00BB00;">y</span>, which will replace the existing scale.</span></span>
<span><span class="co">#&gt; Scale for <span style="color: #00BB00;">y</span> is already present.</span></span>
<span><span class="co">#&gt; Adding another scale for <span style="color: #00BB00;">y</span>, which will replace the existing scale.</span></span>
<span><span class="co">#&gt; Scale for <span style="color: #00BB00;">y</span> is already present.</span></span>
<span><span class="co">#&gt; Adding another scale for <span style="color: #00BB00;">y</span>, which will replace the existing scale.</span></span>
<span><span class="co">#&gt; Scale for <span style="color: #00BB00;">y</span> is already present.</span></span>
<span><span class="co">#&gt; Adding another scale for <span style="color: #00BB00;">y</span>, which will replace the existing scale.</span></span>
<span><span class="co">#&gt; Scale for <span style="color: #00BB00;">y</span> is already present.</span></span>
<span><span class="co">#&gt; Adding another scale for <span style="color: #00BB00;">y</span>, which will replace the existing scale.</span></span>
<span></span>
<span><span class="va">good_names</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">[[</span><span class="st">"derived"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"spatial_plots"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="fl">4</span><span class="op">]</span><span class="op">]</span> <span class="op">+</span> </span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">'bottom'</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">scale_color_manual</span><span class="op">(</span>breaks <span class="op">=</span> <span class="va">mnames_good</span>, </span>
<span>                     values <span class="op">=</span> <span class="va">values</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/match.html" class="external-link">match</a></span><span class="op">(</span><span class="va">mnames_good</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">values</span><span class="op">)</span><span class="op">)</span><span class="op">]</span>,</span>
<span>                     labels <span class="op">=</span> <span class="va">mnames_good</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>                       <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"..Opal.*"</span>, <span class="st">"+"</span>, <span class="va">.</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>                       <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"\\.\\."</span>, <span class="st">"+"</span>, <span class="va">.</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>                       <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"\\."</span>, <span class="st">"+"</span>, <span class="va">.</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Scale for <span style="color: #00BB00;">colour</span> is already present.</span></span>
<span><span class="co">#&gt; Adding another scale for <span style="color: #00BB00;">colour</span>, which will replace the existing scale.</span></span>
<span></span>
<span><span class="va">x</span><span class="op">$</span><span class="va">sample</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">deidentified_sample</span> <span class="op">==</span> <span class="st">'TMA3_[9,K].tif'</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">4</span><span class="op">:</span><span class="fl">15</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">pivot_longer</span><span class="op">(</span>cols <span class="op">=</span> <span class="fl">2</span><span class="op">:</span><span class="fl">13</span>, names_to <span class="op">=</span> <span class="st">'Marker'</span>, values_to <span class="op">=</span> <span class="st">'Count'</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 12 × 3</span></span></span>
<span><span class="co">#&gt;    deidentified_sample Marker                          Count</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>               <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                           <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> TMA3_[9,K].tif      FOXP3 (Opal 620) Positive Cells    34</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> TMA3_[9,K].tif      CD3 (Opal 570) Positive Cells     536</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> TMA3_[9,K].tif      CD8 (Opal 520) Positive Cells      83</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> TMA3_[9,K].tif      PD1 (Opal 650) Positive Cells       5</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> TMA3_[9,K].tif      PDL1 (Opal 540) Positive Cells      1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> TMA3_[9,K].tif      CD3+ FOXP3+ Cells                  34</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> TMA3_[9,K].tif      CD3+ CD8+ Cells                    68</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> TMA3_[9,K].tif      CD3+ CD8+ FOXP3+ Cells              4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> TMA3_[9,K].tif      CD3+ PD1+ Cells                     5</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> TMA3_[9,K].tif      CD3+ PD-L1+ Cells                   1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">11</span> TMA3_[9,K].tif      CD8+ PD1+ Cells                     0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">12</span> TMA3_[9,K].tif      CD3+ CD8+ PD-L1+ Cells              0</span></span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">gridExtra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/gridExtra/man/arrangeGrob.html" class="external-link">grid.arrange</a></span><span class="op">(</span><span class="va">bad_names</span>, <span class="va">good_names</span>, ncol<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="intro_files/figure-html/unnamed-chunk-3-1.png" width="700">
# Estimating the degree of spatial clustering with Count Based
Methods</p>
<div class="section level3">
<h3 id="univariate">Univariate<a class="anchor" aria-label="anchor" href="#univariate"></a>
</h3>
<div class="section level4">
<h4 id="count-based-methods">Count Based Methods<a class="anchor" aria-label="anchor" href="#count-based-methods"></a>
</h4>
<p>Ripley’s <span class="math inline">\(K\)</span> measures the average
number of neighboring cells across each cell. That is, the average (over
all cells) number of cells within a specified radius of a cell. Ripley’s
<span class="math inline">\(K\)</span> is computed as follows:</p>
<p><span class="math display">\[\hat{K}(r) =
\frac{1}{n(n-1)}\sum_{i=1}^{n}\sum_{j\neq i}w_{ij}{\bf 1}{(d(x_i,x_j)\le
r)},\]</span></p>
<p>where <span class="math inline">\(r\)</span> is the specified radius,
<span class="math inline">\(d(x_i,x_j)\)</span> is the distance between
the <span class="math inline">\(i^{th}\)</span> and <span class="math inline">\(j^{th}\)</span> cell, <span class="math inline">\({\bf 1}_A\)</span> is indicator function of event
<span class="math inline">\(A\)</span>, and <span class="math inline">\(w_{ij}\)</span> is the weights that are assigned
for border corrections. The expected value of <span class="math inline">\(\hat{K}(r)\)</span> is <span class="math inline">\(\pi r^2\)</span>, thus <span class="math inline">\(\hat{K}\)</span> is expected to grow as a
quadratic function of <span class="math inline">\(r\)</span>.</p>
<p>There are several edge corrections. Our studies have included a small
number of cells and we recommend using the ‘isotropic’ or
‘translational’ edge correction, as opposed to the ‘border’ edge
correction. The main goal of the edge correction is to account for the
fact that there are unobserved points outside of the region, and the
assumption is that the location of these cells has the same distribution
as the study region. An excellent description of these corrections are
provided <a href="https://book.spatstat.org/sample-chapters/chapter07.pdf" class="external-link">here</a>.</p>
</div>
<div class="section level4">
<h4 id="distance-based-measures">Distance Based Measures<a class="anchor" aria-label="anchor" href="#distance-based-measures"></a>
</h4>
<p>The distribution of the nearest neighbor distances, <span class="math inline">\(\hat{G}(r)\)</span>, can be studied and is
computed by</p>
<p><span class="math display">\[\hat{G}(r) =
\frac{1}{n}\sum_{i=1}^{n}{\bf 1}(\min_{j}(\{d(x_i,x_j)\}\le
r),\]</span></p>
<p>which is interpreted as the proportion of cells whose distance to its
nearest neighbor is less than <span class="math inline">\(r\)</span>.
Notice that there is not a weighting factor for each pair of points as
we saw above. The edge correction in these methods, reduced sample
(<code>rs</code>) and Hanisch (<code>han</code>), simply have different
cell inclusion conditions. The reduced sample correction is similar to
the border correction for count based methods, where the middle chunk of
the area of interest is studied. The Hanisch border correction leaves
out points whose <span class="math inline">\(k^{th}\)</span> neighbor
can not be in the area of interest. For more information about these
border corrections, see the following <a href="https://www.routledgehandbooks.com/pdf/doi/10.1201/b16195-4" class="external-link">article</a>.</p>
</div>
</div>
<div class="section level3">
<h3 id="need-for-permutations">Need for Permutations<a class="anchor" aria-label="anchor" href="#need-for-permutations"></a>
</h3>
<p>An underlying assumption used for many spatial clustering metrics is
that the cells are randomly distributed across the region, no evidence
of clustering or repulsion, and that the cell intensity is constant
across the entire region. This assumption is the so-called complete
spatial randomness (CSR). Damage can occur to tissue cores due to how
they are collected. This damage can lead to rips and tears in the cores
which results in regions where it appears that cells are not located and
is not actually the case. Due to these violations of the CSR assumption,
the theoretical estimate for CSR may not be accurate. To address this
the cell positivity can be permuted across all observed locations and
the permutation distribution of <span class="math inline">\(K\)</span>,
<span class="math inline">\(L\)</span>, <span class="math inline">\(M\)</span>, and <span class="math inline">\(G\)</span> is a core specific measure of CSR than
theoretical. Also, with the permutations of CSR we are able to determine
whether the observed clustering is significant by lying above or below a
95% of permuted CSR estimates.</p>
</div>
<div class="section level3">
<h3 id="calculating-exact-csr">Calculating Exact CSR<a class="anchor" aria-label="anchor" href="#calculating-exact-csr"></a>
</h3>
<p>The product of running all possible permutations of Ripley’s K and
bivariate Ripley’s K for cells on a TMA core or an ROI spot is simply
the result of running Ripley’s K or bivariate Ripley’s K on all cells
ignoring their marks. This allows us to determine the exact degree of
clustering that are can use for associations with survival or other
clinical variables.</p>
</div>
</div>
<div class="section level2">
<h2 id="implementation">Implementation<a class="anchor" aria-label="anchor" href="#implementation"></a>
</h2>
<div class="section level3">
<h3 id="univariate-count-based-methods">Univariate Count-Based Methods<a class="anchor" aria-label="anchor" href="#univariate-count-based-methods"></a>
</h3>
<p>The <code>ripleys_k</code> function reports a permuted and
theoretical estimate of CSR, the observed value for <span class="math inline">\(K\)</span> and the full permutation distribution
of <span class="math inline">\(K\)</span> using
<code>permute = TRUE, keep_permutation_distribution = TRUE</code>.</p>
<p>Currently, the number of permutations is 10, but this should be
increased to at least 100 for a more reliable estimate of the mean.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ripleys_k.html">ripleys_k</a></span><span class="op">(</span>mif <span class="op">=</span> <span class="va">x</span>, mnames <span class="op">=</span> <span class="va">mnames_good</span>, </span>
<span>               num_permutations <span class="op">=</span> <span class="fl">10</span>, method <span class="op">=</span> <span class="st">"K"</span>,</span>
<span>               edge_correction <span class="op">=</span> <span class="st">'translation'</span>, r_range <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">100</span>,</span>
<span>               permute <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>               keep_permutation_distribution <span class="op">=</span> <span class="cn">FALSE</span>, overwrite <span class="op">=</span> <span class="cn">TRUE</span>, workers <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># This will keeps the colors in evx$ery plot for the remainder of the vignette compatible </span></span>
<span><span class="va">values</span> <span class="op">=</span> <span class="fu">RColorBrewer</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/RColorBrewer/man/ColorBrewer.html" class="external-link">brewer.pal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">derived</span><span class="op">$</span><span class="va">univariate_Count</span><span class="op">[[</span><span class="va">x</span><span class="op">$</span><span class="va">sample_id</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>, <span class="st">"Accent"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">values</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">derived</span><span class="op">$</span><span class="va">univariate_Count</span><span class="op">$</span><span class="va">deidentified_sample</span><span class="op">)</span></span>
<span></span>
<span><span class="va">x</span><span class="op">$</span><span class="va">derived</span><span class="op">$</span><span class="va">univariate_Count</span>  <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">Marker</span> <span class="op">!=</span> <span class="st">'PDL1..Opal.540..Positive'</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">r</span>, y <span class="op">=</span> <span class="va">`Degree of Clustering Permutation`</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/get.html" class="external-link">get</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">sample_id</span><span class="op">)</span><span class="op">)</span>, show.legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="va">Marker</span><span class="op">~</span><span class="va">.</span>, scales <span class="op">=</span> <span class="st">'free'</span><span class="op">)</span> <span class="op">+</span> <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">scale_color_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="va">values</span><span class="op">)</span></span></code></pre></div>
<p><img src="intro_files/figure-html/ripleys-1.png" width="960" style="display: block; margin: auto;">
We can also run using the exact CSR approach which is faster and
produces a more accurate Degree of clustering.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ripleys_k.html">ripleys_k</a></span><span class="op">(</span>mif <span class="op">=</span> <span class="va">x</span>, mnames <span class="op">=</span> <span class="va">mnames_good</span>, </span>
<span>               num_permutations <span class="op">=</span> <span class="fl">10</span>, method <span class="op">=</span> <span class="st">"K"</span>,</span>
<span>               edge_correction <span class="op">=</span> <span class="st">'translation'</span>, r_range <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">100</span>,</span>
<span>               permute <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>               keep_permutation_distribution <span class="op">=</span> <span class="cn">FALSE</span>, overwrite <span class="op">=</span> <span class="cn">TRUE</span>, workers <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt; Joining with `by = join_by(r)`</span></span>
<span><span class="co">#&gt; Joining with `by = join_by(r)`</span></span>
<span><span class="co">#&gt; Joining with `by = join_by(r)`</span></span>
<span><span class="co">#&gt; Joining with `by = join_by(r)`</span></span>
<span><span class="co">#&gt; Joining with `by = join_by(r)`</span></span>
<span></span>
<span><span class="co"># This will keeps the colors in evx$ery plot for the remainder of the vignette compatible </span></span>
<span><span class="va">values</span> <span class="op">=</span> <span class="fu">RColorBrewer</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/RColorBrewer/man/ColorBrewer.html" class="external-link">brewer.pal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">derived</span><span class="op">$</span><span class="va">univariate_Count</span><span class="op">[[</span><span class="va">x</span><span class="op">$</span><span class="va">sample_id</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>, <span class="st">"Accent"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">values</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">derived</span><span class="op">$</span><span class="va">univariate_Count</span><span class="op">$</span><span class="va">deidentified_sample</span><span class="op">)</span></span>
<span></span>
<span><span class="va">x</span><span class="op">$</span><span class="va">derived</span><span class="op">$</span><span class="va">univariate_Count</span>  <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">Marker</span> <span class="op">!=</span> <span class="st">'PDL1..Opal.540..Positive'</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">r</span>, y <span class="op">=</span> <span class="va">`Degree of Clustering Exact`</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/get.html" class="external-link">get</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">sample_id</span><span class="op">)</span><span class="op">)</span>, show.legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="va">Marker</span><span class="op">~</span><span class="va">.</span>, scales <span class="op">=</span> <span class="st">'free'</span><span class="op">)</span> <span class="op">+</span> <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">scale_color_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="va">values</span><span class="op">)</span></span></code></pre></div>
<p><img src="intro_files/figure-html/ripleys_exact-1.png" width="960" style="display: block; margin: auto;"></p>
<p>Positive values for degree of cluster when using
<code>method = 'K'</code> indicates evidence of spatial clustering,
while negative values correspond to spatial regularity. We can also
observe that the <code>permute = TRUE</code> method is slightly more
jagged in it’s curve smoothness than the <code>permute = FALSE</code>
method (FOXP3 negative curves in particular).</p>
</div>
<div class="section level3">
<h3 id="sensitivity-of-r">Sensitivity of r<a class="anchor" aria-label="anchor" href="#sensitivity-of-r"></a>
</h3>
<p>There is no clear way to select which value of <span class="math inline">\(r\)</span> to use for a particular analysis. Below
we illustrate how the degree of clustering can change with the value of
<span class="math inline">\(r\)</span>. Notice that for values of <span class="math inline">\(r &gt; 20\)</span> that there is very little
difference in the ordering between the samples (though the degree of
spatial clustering can changes dramatically), while very small values
<span class="math inline">\(r\)</span> would have different results.
It’s typically recommended to pick an <span class="math inline">\(r\)</span> in a region that is of interest (small
scale or large scale clustering) where there is higher variation in the
Degree of Clustering values between samples.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span><span class="op">$</span><span class="va">derived</span><span class="op">$</span><span class="va">univariate_Count</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">Marker</span> <span class="op">==</span> <span class="st">'CD3..CD8.'</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">inner_join</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">clinical</span>,<span class="va">.</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>shape <span class="op">=</span> <span class="va">status</span>, y <span class="op">=</span> <span class="va">`Degree of Clustering Exact`</span>, x <span class="op">=</span><span class="va">r</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/get.html" class="external-link">get</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">sample_id</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu">scale_color_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="va">values</span><span class="op">)</span></span>
<span><span class="co">#&gt; Joining with `by = join_by(deidentified_sample)`</span></span></code></pre></div>
<p><img src="intro_files/figure-html/unnamed-chunk-4-1.png" width="960" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="bivariate-count-based-methods">Bivariate Count-Based Methods<a class="anchor" aria-label="anchor" href="#bivariate-count-based-methods"></a>
</h3>
<p>In the univariate case, we consider each cell of a single cell type
and center circles around each cell (reference cell). In the bivariate
case, we are interested in how many cells of Type 1 (Counted) are
clustered in proximity to Type 2 (Anchor). Here the circles are centered
around cell of Type 2 and then the cells of Type 1 are counted. Similar
to univariate Ripley’s K, we will run 10 permutations to get an average
permuted CSR value.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bi_ripleys_k.html">bi_ripleys_k</a></span><span class="op">(</span>mif <span class="op">=</span> <span class="va">x</span>, mnames <span class="op">=</span> <span class="va">mnames_good</span>, </span>
<span>                  num_permutations <span class="op">=</span> <span class="fl">10</span>, </span>
<span>                  permute<span class="op">=</span><span class="cn">TRUE</span>,</span>
<span>                  edge_correction <span class="op">=</span> <span class="st">'translation'</span>, r_range <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">100</span>,</span>
<span>                  keep_permutation_distribution <span class="op">=</span> <span class="cn">FALSE</span>, workers <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">x</span><span class="op">$</span><span class="va">derived</span><span class="op">$</span><span class="va">bivariate_Count</span>  <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">Anchor</span> <span class="op">==</span> <span class="st">'CD3..FOXP3.'</span>,</span>
<span>         <span class="va">Counted</span> <span class="op">==</span> <span class="st">'CD3..CD8.'</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">r</span>, y <span class="op">=</span> <span class="va">`Degree of Clustering Permutation`</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/get.html" class="external-link">get</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">sample_id</span><span class="op">)</span><span class="op">)</span>, show.legend <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu">scale_color_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="va">values</span><span class="op">)</span></span></code></pre></div>
<p><img src="intro_files/figure-html/unnamed-chunk-5-1.png" width="960" style="display: block; margin: auto;"></p>
<p>We can also do the same as with the univariate Ripley’s K and set
<code>permute = FALSE</code> in order to get the exact CSR estimate and
degree of clustering.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bi_ripleys_k.html">bi_ripleys_k</a></span><span class="op">(</span>mif <span class="op">=</span> <span class="va">x</span>, mnames <span class="op">=</span> <span class="va">mnames_good</span>, </span>
<span>                  num_permutations <span class="op">=</span> <span class="fl">10</span>, </span>
<span>                  permute<span class="op">=</span><span class="cn">FALSE</span>,</span>
<span>                  edge_correction <span class="op">=</span> <span class="st">'translation'</span>, r_range <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">100</span>,</span>
<span>                  keep_permutation_distribution <span class="op">=</span> <span class="cn">FALSE</span>, </span>
<span>                  overwrite <span class="op">=</span> <span class="cn">TRUE</span>, workers <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">x</span><span class="op">$</span><span class="va">derived</span><span class="op">$</span><span class="va">bivariate_Count</span>  <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">Anchor</span> <span class="op">==</span> <span class="st">'CD3..FOXP3.'</span>,</span>
<span>         <span class="va">Counted</span> <span class="op">==</span> <span class="st">'CD3..CD8.'</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">r</span>, y <span class="op">=</span> <span class="va">`Degree of Clustering Exact`</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/get.html" class="external-link">get</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">sample_id</span><span class="op">)</span><span class="op">)</span>, show.legend <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu">scale_color_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="va">values</span><span class="op">)</span></span></code></pre></div>
<p><img src="intro_files/figure-html/unnamed-chunk-6-1.png" width="960" style="display: block; margin: auto;"></p>
<p>The interpretation of the degree of clustering is the same here. The
line for TMA3_[8,U].tif shows evidence that Tregs tend to cluster around
Cytotoxic T cells for all values of <span class="math inline">\(r\)</span>, while the line for TMA1_[3,B].tif
indicates spatial repulsion of Tregs by Cytotoxic T cells for <span class="math inline">\(r\gt50\)</span>. Again, we can see that the curves
for the exact degree of clustering are more smooth than those using the
permutation method. The permutation method would produce more smooth
curve with an increase in the number of permutations</p>
</div>
<div class="section level3">
<h3 id="univariate-nearest-neighbor-methods">Univariate Nearest-Neighbor Methods<a class="anchor" aria-label="anchor" href="#univariate-nearest-neighbor-methods"></a>
</h3>
<p>The <code>NN_G</code> function reports a permuted and theoretical
estimate of CSR, the observed value for <span class="math inline">\(G\)</span>, and the full permutation distribution
of <span class="math inline">\(G\)</span> when
<code>keep_perm_dis = TRUE</code>. The degree of clustering is computed
by taking the ratio of the observed <span class="math inline">\(G\)</span> and either the permutation or
theoretical estimate of CSR.</p>
<p>Currently, the number of permutations is 10, but this should be
increased to at least 100 for a more reliable estimate of the mean.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NN_G.html">NN_G</a></span><span class="op">(</span>mif <span class="op">=</span> <span class="va">x</span>, mnames <span class="op">=</span> <span class="va">mnames_good</span>, num_permutations <span class="op">=</span> <span class="fl">10</span>,</span>
<span>                edge_correction <span class="op">=</span> <span class="st">'rs'</span>, r <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">100</span>, workers <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">x</span><span class="op">$</span><span class="va">derived</span><span class="op">$</span><span class="va">univariate_NN</span>  <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">Marker</span> <span class="op">!=</span> <span class="st">'PDL1..Opal.540..Positive'</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">r</span>, y <span class="op">=</span> <span class="va">`Degree of Clustering Permutation`</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/get.html" class="external-link">get</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">sample_id</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="va">Marker</span><span class="op">~</span><span class="va">.</span>, scales <span class="op">=</span> <span class="st">'free'</span><span class="op">)</span> <span class="op">+</span> <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">scale_color_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="va">values</span><span class="op">)</span></span></code></pre></div>
<p><img src="intro_files/figure-html/NN-1.png" width="960" style="display: block; margin: auto;"></p>
<p>The interpretation of the degree of clustering for <span class="math inline">\(G\)</span> that values greater than 0 indicate
spatial clustering of the cell types of interest, while values less than
0 indicate dispersion of these cells. For example in core TMA2_[3,B],
<code>FOXP3..Opal.620..Positive</code> shows spatial dispersion from
<span class="math inline">\(0\le r \le50\)</span> (less than zero),
while <code>CD3..Opal.570..Positive</code> for core TMA2_[3,B] shows
spatial clustering <span class="math inline">\(0\le r\le75\)</span>
(greater than zero).</p>
</div>
<div class="section level3">
<h3 id="bivariate-nearest-neighbor-methods">Bivariate Nearest-Neighbor Methods<a class="anchor" aria-label="anchor" href="#bivariate-nearest-neighbor-methods"></a>
</h3>
<p>The interpretation of the bivariate nearest neighbor distribution is
similar to bivariate Ripley’s <span class="math inline">\(K\)</span>, in
that we are measuring the degree of clustering of one cell type with
respect to another. The actual value of degree of clustering is
interpreted in the same manner as the univariate nearest neighbor
distribution.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bi_NN_G.html">bi_NN_G</a></span><span class="op">(</span>mif <span class="op">=</span> <span class="va">x</span>, mnames <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"CD3..CD8."</span>, <span class="st">"CD3..FOXP3."</span><span class="op">)</span>, num_permutations <span class="op">=</span> <span class="fl">10</span>,</span>
<span>               edge_correction <span class="op">=</span> <span class="st">'rs'</span>, r <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">100</span>, workers <span class="op">=</span> <span class="fl">1</span>, overwrite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">x</span><span class="op">$</span><span class="va">derived</span><span class="op">$</span><span class="va">bivariate_NN</span>  <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">anchor</span> <span class="op">==</span> <span class="st">'CD3..FOXP3.'</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">r</span>, y <span class="op">=</span> <span class="va">`Degree of Clustering Permutation`</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>color <span class="op">=</span> <span class="va">deidentified_sample</span><span class="op">)</span>, show.legend <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>  <span class="fu">scale_color_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="va">values</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Removed 291 rows containing missing values (`geom_line()`).</span></span></code></pre></div>
<p><img src="intro_files/figure-html/unnamed-chunk-7-1.png" width="960" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="permutation-distribution">Permutation Distribution<a class="anchor" aria-label="anchor" href="#permutation-distribution"></a>
</h3>
<p>For this example, we use the same data used above for plotting cell
locations. Now we only focus on the same TMA core and only focus on CD3
positive cells. In this particular TMA core, we can see that the overall
cell distribution is not uniform (i.e. there are many regions where
cells do not occur). Also notice, that there the CD3+ cells occur mostly
in two places, thus we suspect that the degree of clustering is quite
large in this TMA core.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/plot_immunoflo.html">plot_immunoflo</a></span><span class="op">(</span><span class="va">x</span>, plot_title <span class="op">=</span> <span class="st">"deidentified_sample"</span>, mnames <span class="op">=</span> <span class="va">mnames_good</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, </span>
<span>                    cell_type <span class="op">=</span> <span class="st">"Classifier.Label"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in RColorBrewer::brewer.pal(length(mnames), "Paired"): minimal value for n is 3, returning requested palette with 3 different levels</span></span>
<span><span class="co">#&gt; Scale for <span style="color: #00BB00;">y</span> is already present.</span></span>
<span><span class="co">#&gt; Adding another scale for <span style="color: #00BB00;">y</span>, which will replace the existing scale.</span></span>
<span><span class="co">#&gt; Warning in RColorBrewer::brewer.pal(length(mnames), "Paired"): minimal value for n is 3, returning requested palette with 3 different levels</span></span>
<span><span class="co">#&gt; Scale for <span style="color: #00BB00;">y</span> is already present.</span></span>
<span><span class="co">#&gt; Adding another scale for <span style="color: #00BB00;">y</span>, which will replace the existing scale.</span></span>
<span><span class="co">#&gt; Warning in RColorBrewer::brewer.pal(length(mnames), "Paired"): minimal value for n is 3, returning requested palette with 3 different levels</span></span>
<span><span class="co">#&gt; Scale for <span style="color: #00BB00;">y</span> is already present.</span></span>
<span><span class="co">#&gt; Adding another scale for <span style="color: #00BB00;">y</span>, which will replace the existing scale.</span></span>
<span><span class="co">#&gt; Warning in RColorBrewer::brewer.pal(length(mnames), "Paired"): minimal value for n is 3, returning requested palette with 3 different levels</span></span>
<span><span class="co">#&gt; Scale for <span style="color: #00BB00;">y</span> is already present.</span></span>
<span><span class="co">#&gt; Adding another scale for <span style="color: #00BB00;">y</span>, which will replace the existing scale.</span></span>
<span><span class="co">#&gt; Warning in RColorBrewer::brewer.pal(length(mnames), "Paired"): minimal value for n is 3, returning requested palette with 3 different levels</span></span>
<span><span class="co">#&gt; Scale for <span style="color: #00BB00;">y</span> is already present.</span></span>
<span><span class="co">#&gt; Adding another scale for <span style="color: #00BB00;">y</span>, which will replace the existing scale.</span></span>
<span></span>
<span><span class="va">x</span><span class="op">[[</span><span class="st">"derived"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"spatial_plots"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="fl">4</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="intro_files/figure-html/unnamed-chunk-8-1.png" alt="Cell locations for a particular TMA core where the blue cells are CD3+ cells and the grey cells are CD3- cells. Notice that there is a much larger quantity on the left than the right half indicating that there is some clustering occuring." width="960"><p class="caption">
Cell locations for a particular TMA core where the blue cells are CD3+
cells and the grey cells are CD3- cells. Notice that there is a much
larger quantity on the left than the right half indicating that there is
some clustering occuring.
</p>
</div>
<p>Below is an example that shows how to select a single value for <span class="math inline">\(r\)</span>, and how one can visualize the
permutation distribution as it relates to the theoretical and observed
values. Here we plot the permutation distribution for the CD3+ cells
with <span class="math inline">\(r = 50\)</span>. Note that the range of
<span class="math inline">\(r\)</span> that is included must contain 0
and the output will not include the degree of clustering at <span class="math inline">\(r = 0\)</span>, which is 0 for <span class="math inline">\(K\)</span> and <span class="math inline">\(L\)</span>, and <span class="math inline">\(\infty\)</span> for <span class="math inline">\(M\)</span>. Notice that the theoretical value is
smaller than all 100 values from the permutation distribution.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ripleys_k.html">ripleys_k</a></span><span class="op">(</span>mif <span class="op">=</span> <span class="va">x</span>, mnames <span class="op">=</span> <span class="va">mnames_good</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, num_permutations <span class="op">=</span> <span class="fl">100</span>,</span>
<span>               edge_correction <span class="op">=</span> <span class="st">'translation'</span>, r <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">50</span><span class="op">)</span>,</span>
<span>               permute <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>               keep_permutation_distribution <span class="op">=</span> <span class="cn">TRUE</span>, workers <span class="op">=</span> <span class="fl">1</span>, overwrite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#Computed the mean of the permutation distribution for a particular image</span></span>
<span><span class="va">perm_mean</span>  <span class="op">=</span> <span class="va">x</span><span class="op">$</span><span class="va">derived</span><span class="op">$</span><span class="va">univariate_Count</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">deidentified_sample</span> <span class="op">==</span> <span class="st">'TMA3_[9,K].tif'</span>,</span>
<span>         <span class="va">r</span> <span class="op">==</span> <span class="fl">50</span><span class="op">)</span>  <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>`Permuted CSR` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">`Permuted CSR`</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">x</span><span class="op">$</span><span class="va">derived</span><span class="op">$</span><span class="va">univariate_Count</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">deidentified_sample</span> <span class="op">==</span> <span class="st">'TMA3_[9,K].tif'</span>,</span>
<span>         <span class="va">r</span> <span class="op">==</span> <span class="fl">50</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">`Permuted CSR`</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_histogram</span><span class="op">(</span>color <span class="op">=</span> <span class="st">'white'</span>, bins <span class="op">=</span> <span class="fl">50</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="va">`Theoretical CSR`</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">'red'</span>, size <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="va">`Observed K`</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">'blue'</span>, size <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="va">perm_mean</span>, color <span class="op">=</span> <span class="st">'green'</span>, size <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Using `size` aesthetic for lines was deprecated in ggplot2 3.4.0.</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Please use `linewidth` instead.</span></span>
<span><span class="co">#&gt; <span style="color: #555555;">This warning is displayed once every 8 hours.</span></span></span>
<span><span class="co">#&gt; <span style="color: #555555;">Call `lifecycle::last_lifecycle_warnings()` to see where this warning was</span></span></span>
<span><span class="co">#&gt; <span style="color: #555555;">generated.</span></span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="intro_files/figure-html/unnamed-chunk-9-1.png" alt="Histogram displaying how much the permuted estimates of K (100 permutations) can vary. This also illustrates how different the permutation distribution and its mean (green vertical line) can be from the theoretical value (red vertical line) or observed value (blue vertical line). Lastly, this plot confirms what we see visually above in that the CD3+ cells are not uniformly distributed throughout this slide, but clustered." width="960"><p class="caption">
Histogram displaying how much the permuted estimates of K (100
permutations) can vary. This also illustrates how different the
permutation distribution and its mean (green vertical line) can be from
the theoretical value (red vertical line) or observed value (blue
vertical line). Lastly, this plot confirms what we see visually above in
that the CD3+ cells are not uniformly distributed throughout this slide,
but clustered.
</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="subsetting-by-compartment">Subsetting by Compartment<a class="anchor" aria-label="anchor" href="#subsetting-by-compartment"></a>
</h2>
<p>Many studies may only interested in the spatial location within the
tumor or stroma compartment instead of studying all cells. By using the
<code>subset_mif</code> function which requires the column
(Classifier.Label in our example) and label of cells desired (Tumor here
meaning that we want to focus our analysis on only the tumor
compartment).</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x_tumor</span> <span class="op">=</span> <span class="fu"><a href="../reference/subset_mif.html">subset_mif</a></span><span class="op">(</span><span class="va">x</span>, classifier <span class="op">=</span> <span class="st">'Classifier.Label'</span>, level <span class="op">=</span> <span class="st">'Tumor'</span>, markers <span class="op">=</span> <span class="va">mnames_good</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">spatial</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">Classifier.Label</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Stroma  Tumor </span></span>
<span><span class="co">#&gt;    192   3611</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">x_tumor</span><span class="op">$</span><span class="va">spatial</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">Classifier.Label</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Tumor </span></span>
<span><span class="co">#&gt;  3611</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="follow-up-analysis">Follow-up Analysis<a class="anchor" aria-label="anchor" href="#follow-up-analysis"></a>
</h2>
<p>Once the degree of spatial clustering has be computed, questions like
“Is the degree of clustering for CD3+ cells between two populations
different? (t-test) or”Is the pattern of degree of clustering different
between two populations?” (can be checked visually with a heatmap) may
be answered.</p>
<p>Due to space constraints, there are only 5 TMA cores included in the
example dataset. Thus, visualization is included and no statistical
analysis will be conducted. With this very limited number of samples it
does look like there is some evidence that CD3+CD8+, CD8+, and FOXP3+
are more clustered in patients from status B than status A, while the
CD3+ cells are less clustered in patients with status B.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ripleys_k.html">ripleys_k</a></span><span class="op">(</span>mif <span class="op">=</span> <span class="va">x</span>, mnames <span class="op">=</span> <span class="va">mnames_good</span>, num_permutations <span class="op">=</span> <span class="fl">10</span>,</span>
<span>               edge_correction <span class="op">=</span> <span class="st">'translation'</span>, r <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">50</span><span class="op">)</span>, permute <span class="op">=</span> <span class="cn">T</span>,</span>
<span>               keep_permutation_distribution <span class="op">=</span> <span class="cn">FALSE</span>, workers <span class="op">=</span> <span class="fl">1</span>, overwrite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">inner_join</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">clinical</span>, <span class="va">x</span><span class="op">$</span><span class="va">derived</span><span class="op">$</span><span class="va">univariate_Count</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">'CD3..O|CD8..O'</span>, <span class="va">Marker</span><span class="op">)</span>, <span class="va">r</span> <span class="op">==</span> <span class="fl">50</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">status</span>, y <span class="op">=</span> <span class="va">`Degree of Clustering Permutation`</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_point</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>color <span class="op">=</span> <span class="va">deidentified_sample</span><span class="op">)</span>, show.legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="va">Marker</span> <span class="op">~</span><span class="va">.</span>, scales <span class="op">=</span> <span class="st">'free'</span><span class="op">)</span> </span>
<span><span class="co">#&gt; Joining with `by = join_by(deidentified_sample)`</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="intro_files/figure-html/unnamed-chunk-11-1.png" alt="Scatter plots showing the difference in degree of spatial clustering for CD3+, and CD8+ cells. These markers were selected since all 5 examples spatial files had at least 2 to these cells." width="960"><p class="caption">
Scatter plots showing the difference in degree of spatial clustering for
CD3+, and CD8+ cells. These markers were selected since all 5 examples
spatial files had at least 2 to these cells.
</p>
</div>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">Rip_K_df</span> <span class="op">=</span> <span class="va">x</span><span class="op">$</span><span class="va">derived</span><span class="op">$</span><span class="va">univariate_Count</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="op">(</span><span class="va">Marker</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'PDL1..Opal.540..Positive'</span>, </span>
<span>                         <span class="st">'CD3..FOXP3.'</span>,</span>
<span>                         <span class="st">'PD1..Opal.650..Positive'</span><span class="op">)</span><span class="op">)</span>, <span class="va">r</span> <span class="op">==</span> <span class="fl">50</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">deidentified_sample</span>, <span class="va">Marker</span>, <span class="va">`Degree of Clustering Permutation`</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">pivot_wider</span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">deidentified_sample</span>, values_from <span class="op">=</span> <span class="va">`Degree of Clustering Permutation`</span>,</span>
<span>              id_cols <span class="op">=</span> <span class="va">Marker</span><span class="op">)</span></span>
<span><span class="co">#&gt; Adding missing grouping variables: `iter`</span></span>
<span></span>
<span><span class="va">Rip_K_matrix</span> <span class="op">=</span> <span class="va">Rip_K_df</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">Marker</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">Rip_K_matrix</span><span class="op">)</span> <span class="op">=</span> <span class="va">Rip_K_df</span><span class="op">$</span><span class="va">Marker</span></span>
<span></span>
<span><span class="va">annotation</span> <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">inner_join</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">clinical</span>, <span class="va">x</span><span class="op">$</span><span class="va">derived</span><span class="op">$</span><span class="va">univariate_Count</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">deidentified_sample</span>, <span class="va">status</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/duplicated.html" class="external-link">duplicated</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Joining with `by = join_by(deidentified_sample)`</span></span>
<span>  </span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">annotation</span><span class="op">)</span> <span class="op">=</span> <span class="va">annotation</span><span class="op">$</span><span class="va">deidentified_sample</span></span>
<span></span>
<span><span class="va">annotation</span> <span class="op">=</span> <span class="va">annotation</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">status</span><span class="op">)</span></span>
<span>  </span>
<span><span class="fu">pheatmap</span><span class="op">(</span><span class="va">Rip_K_matrix</span>, treeheight_row <span class="op">=</span> <span class="fl">0</span>, treeheight_col <span class="op">=</span> <span class="fl">0</span>, </span>
<span>                   cluster_cols <span class="op">=</span> <span class="cn">FALSE</span>, annotation <span class="op">=</span> <span class="va">annotation</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="intro_files/figure-html/unnamed-chunk-12-1.png" alt="Heatmaps showing a potential descriptive visualization for identifying difference patterns within multiple markers across different populations." width="960"><p class="caption">
Heatmaps showing a potential descriptive visualization for identifying
difference patterns within multiple markers across different
populations.
</p>
</div>
</div>
<div class="section level2">
<h2 id="using-custom-cell-locations">Using Custom Cell Locations<a class="anchor" aria-label="anchor" href="#using-custom-cell-locations"></a>
</h2>
<p>If <code>xloc</code> and <code>yloc</code> are set as
<code>NULL</code>, when computing spatial clustering than the cell
location is the center of the cell (x-coordinate is the average of
<code>XMin</code> and <code>XMax</code>, and y-coordinate is the average
of <code>YMin</code> and <code>YMax</code>). If you desire to use custom
points, this is possible by identifying which column the new coordinates
are from. Here were compute Ripley’s <span class="math inline">\(K\)</span> with the minimum coordinate of x and
y.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ripleys_k.html">ripleys_k</a></span><span class="op">(</span>mif <span class="op">=</span> <span class="va">x</span>, mnames <span class="op">=</span> <span class="va">mnames_good</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, num_permutations <span class="op">=</span> <span class="fl">100</span>,</span>
<span>               edge_correction <span class="op">=</span> <span class="st">'translation'</span>, r <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">50</span><span class="op">)</span>,permute <span class="op">=</span> <span class="cn">T</span>, </span>
<span>               keep_permutation_distribution <span class="op">=</span> <span class="cn">TRUE</span>, workers <span class="op">=</span> <span class="fl">1</span>, overwrite <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>               xloc <span class="op">=</span> <span class="st">'XMin'</span>, yloc <span class="op">=</span> <span class="st">'YMin'</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: data contain duplicated points</span></span></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Jordan Creed, Ram Thapa, Christopher Wilson, Alex Soupir, Oscar Ospina, Julia Wrobel, Fridley Lab.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
